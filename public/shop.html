<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Textile | Quality Curtains Rwanda</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Branding Colors */
            --primary: #c2410c; /* Burnt Orange/Red for Textile vibe */
            --primary-hover: #9a3412;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-muted: #64748b;
            --success: #16a34a;
            --warning: #ca8a04;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; font-size: 14px; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .btn { padding: 12px 24px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-success { background: var(--success); color: white; }
        
        /* --- NAV --- */
        nav { height: 70px; display: flex; align-items: center; justify-content: space-between; padding: 0 5%; background: var(--surface); position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid var(--border); }
        .logo { font-weight: 800; font-size: 1.4rem; color: var(--primary); display: flex; align-items: center; gap: 8px; text-transform: uppercase; letter-spacing: -0.5px; }
        .nav-tools { display: flex; gap: 15px; align-items: center; }
        .icon-btn { position: relative; width: 40px; height: 40px; border-radius: 50%; background: var(--bg); display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid var(--border); transition: 0.2s; }
        .icon-btn:hover { background: var(--border); }
        .badge { position: absolute; top: -2px; right: -2px; background: var(--primary); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; }

        /* --- LAYOUTS --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 30px 5%; width: 100%; flex: 1; }
        
        /* --- STOREFRONT --- */
        .hero { text-align: center; margin-bottom: 40px; padding: 40px 20px; background: var(--surface); border-radius: 20px; border: 1px solid var(--border); }
        .hero h1 { font-size: 2.2rem; margin-bottom: 10px; color: var(--text); }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 5px; justify-content: center; }
        .tab { padding: 10px 24px; border-radius: 30px; background: var(--surface); border: 1px solid var(--border); cursor: pointer; white-space: nowrap; font-weight: 600; transition: 0.2s; }
        .tab:hover { border-color: var(--primary); }
        .tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; }
        .card { background: var(--surface); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; cursor: pointer; transition: 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow); border-color: var(--primary); }
        
        .card-img { height: 220px; background: #f1f5f9; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .card-img img { width: 100%; height: 100%; object-fit: cover; }
        .card-tag { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; backdrop-filter: blur(4px); }
        .card-info { padding: 15px; }
        .card h3 { font-size: 1.1rem; margin-bottom: 5px; }

        /* --- ADMIN PANEL --- */
        #admin-view { background: var(--surface); border-radius: 20px; border: 1px solid var(--border); padding: 30px; box-shadow: var(--shadow); }
        .admin-nav { display: flex; gap: 20px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
        .admin-tab { padding: 10px 0; cursor: pointer; color: var(--text-muted); font-weight: 600; border-bottom: 2px solid transparent; }
        .admin-tab:hover { color: var(--primary); }
        .admin-tab.active { color: var(--primary); border-color: var(--primary); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        .form-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); outline: none; background: var(--bg); transition: 0.2s; }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(194, 65, 12, 0.1); }
        
        /* Order Table */
        .order-card { border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 15px; background: var(--bg); display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
        .order-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed var(--border); padding-bottom: 10px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        .status-delivery { background: #dbeafe; color: #1e40af; }
        .status-pickup { background: #f3e8ff; color: #6b21a8; }

        /* --- MODALS --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; place-items: center; z-index: 5000; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--surface); width: 100%; max-width: 900px; border-radius: 24px; overflow: hidden; display: flex; max-height: 90vh; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        @media (max-width: 768px) { .modal-content { flex-direction: column; overflow-y: auto; } }
        
        .login-box { background: var(--surface); padding: 40px; border-radius: 24px; width: 100%; max-width: 400px; text-align: center; }

        /* --- CART SIDEBAR --- */
        .cart-sidebar { position: fixed; top: 0; right: -450px; width: 450px; height: 100vh; background: var(--surface); z-index: 4000; border-left: 1px solid var(--border); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.1); }
        @media(max-width: 500px) { .cart-sidebar { width: 100%; } }
        .cart-sidebar.open { right: 0; }

        /* --- CHECKOUT --- */
        .fulfillment-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .f-btn { padding: 15px; border: 1px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; background: var(--bg); font-weight: 600; transition: 0.2s; }
        .f-btn:hover { border-color: var(--primary); }
        .f-btn.active { border-color: var(--primary); background: #fff7ed; color: var(--primary); }
    </style>
</head>
<body>

    <nav>
        <div class="logo">
            <i data-lucide="layers"></i> New Textile
        </div>
        <div class="nav-tools">
            <button class="icon-btn" onclick="checkAdminAccess()" title="Admin Login">
                <i data-lucide="lock"></i>
            </button>
            <button class="icon-btn" onclick="toggleCart()">
                <i data-lucide="shopping-cart"></i>
                <span class="badge" id="cart-count">0</span>
            </button>
        </div>
    </nav>

    <main class="container">
        <div id="store-view">
            <div class="hero">
                <h1>New Textile Company Ltd</h1>
                <p style="color: var(--text-muted); max-width: 600px; margin: 0 auto;">
                    We provide the highest quality curtains (rideau) and home accessories in Rwanda. 
                    Choose between Day & Night curtains or accessories.
                </p>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="filterProducts('all', this)">All Collections</div>
                <div class="tab" onclick="filterProducts('night', this)">Night Curtains</div>
                <div class="tab" onclick="filterProducts('day', this)">Day Curtains</div>
                <div class="tab" onclick="filterProducts('accessory', this)">Accessories</div>
            </div>
            
            <div class="grid" id="product-grid">
                </div>
        </div>

        <div id="admin-view" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div>
                    <h2 style="font-size: 1.5rem;">Admin Dashboard</h2>
                    <p style="color: var(--text-muted);">Manage New Textile Inventory</p>
                </div>
                <button class="btn btn-outline" onclick="adminLogout()">
                    <i data-lucide="log-out"></i> Logout
                </button>
            </div>
            
            <div class="admin-nav">
                <div class="admin-tab active" onclick="switchAdminTab('inventory', this)">Inventory</div>
                <div class="admin-tab" onclick="switchAdminTab('orders', this)">Orders</div>
            </div>

            <div id="tab-inventory">
                <div style="background: var(--bg); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 15px; display:flex; align-items:center; gap:8px;"><i data-lucide="plus-circle"></i> Add New Product</h3>
                    <form onsubmit="handleAddProduct(event)">
                        <div class="form-grid">
                            <div>
                                <label style="display:block; margin-bottom:5px; font-weight:600;">Product Name</label>
                                <input type="text" id="p-name" class="form-input" placeholder="e.g. Velvet Gold" required>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:5px; font-weight:600;">Category</label>
                                <select id="p-cat" class="form-input">
                                    <option value="night">Night Curtain (Z'ijoro)</option>
                                    <option value="day">Day Curtain (Z'amanywa)</option>
                                    <option value="accessory">Accessory (Ibikoresho)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:5px; font-weight:600;">Price (RWF)</label>
                                <input type="number" id="p-price" class="form-input" placeholder="e.g. 15000" required>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:5px; font-weight:600;">Upload Image</label>
                                <input type="file" id="p-file" class="form-input" accept="image/*" required>
                                <small style="color:var(--text-muted)">Max size 2MB (JPG/PNG)</small>
                            </div>
                        </div>
                        <textarea id="p-desc" class="form-input" rows="2" placeholder="Product Description..." style="margin-bottom:15px;"></textarea>
                        <button type="submit" class="btn btn-primary" style="width:100%">Save Product</button>
                    </form>
                </div>
                <h3>Current Stock</h3>
                <div id="admin-list" style="display:grid; gap:10px; margin-top:15px;"></div>
            </div>

            <div id="tab-orders" class="hidden">
                <h3>Incoming Orders</h3>
                <div id="orders-list" style="margin-top:15px;"></div>
            </div>
        </div>
    </main>

    <div id="login-modal" class="modal">
        <div class="login-box">
            <i data-lucide="shield-check" style="width:50px; height:50px; color:var(--primary); margin-bottom:15px;"></i>
            <h2 style="margin-bottom:10px;">Security Check</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">Enter Admin password to continue</p>
            <input type="password" id="admin-pass" class="form-input" placeholder="Password" style="margin-bottom:15px; text-align:center;">
            <button class="btn btn-primary" style="width:100%" onclick="attemptLogin()">Login</button>
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="closeModals()">Cancel</button>
            <p style="margin-top:15px; font-size:0.8rem; color:red;" id="login-error"></p>
        </div>
    </div>

    <div id="product-modal" class="modal" onclick="closeModals()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="flex:1; background:#f0f0f0; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                <img id="m-img" src="" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <div style="flex:1; padding:40px; display:flex; flex-direction:column; overflow-y:auto;">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <span id="m-tag" class="status-badge" style="background:var(--text); color:white;">TAG</span>
                    <button onclick="closeModals()" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
                </div>
                
                <h2 id="m-title" style="font-size:2rem; margin:15px 0 5px;">Title</h2>
                <p id="m-price" style="color:var(--primary); font-weight:700; font-size:1.5rem; margin-bottom:20px;">0 RWF</p>
                <p id="m-desc" style="color:var(--text-muted); line-height:1.6; margin-bottom:30px;"></p>
                
                <div style="background:var(--bg); padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
                    <div id="input-measure" class="hidden">
                        <label style="font-weight:600; display:block; margin-bottom:8px;">How many meters width?</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" id="calc-val-m" value="1" min="1" step="0.5" class="form-input" oninput="updateTotal()">
                            <span>Meters</span>
                        </div>
                    </div>
                    <div id="input-qty" class="hidden">
                        <label style="font-weight:600; display:block; margin-bottom:8px;">Quantity needed:</label>
                        <input type="number" id="calc-val-q" value="1" min="1" class="form-input" oninput="updateTotal()">
                    </div>
                    <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:600;">Total Amount:</span>
                        <span id="calc-total" style="font-size:1.4rem; font-weight:800; color:var(--primary);">0 RWF</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addToCart()" style="padding:15px;">
                    Add to Cart <i data-lucide="arrow-right" style="width:18px;"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="modal">
        <div class="login-box" style="text-align:left; max-width:550px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Confirm Order</h2>
                <button onclick="closeModals()" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            
            <form onsubmit="submitOrder(event)">
                <div class="form-grid" style="gap:15px;">
                    <div>
                        <label>Full Name</label>
                        <input type="text" id="c-name" class="form-input" required>
                    </div>
                    <div>
                        <label>Phone (WhatsApp)</label>
                        <input type="tel" id="c-phone" class="form-input" placeholder="07..." required>
                    </div>
                </div>
                
                <label style="font-weight:600; margin-top:10px; display:block;">Delivery Method</label>
                <div class="fulfillment-options">
                    <div id="opt-delivery" class="f-btn active" onclick="setFulfillment('Delivery')">
                        <i data-lucide="bike"></i><br>Moto Delivery
                    </div>
                    <div id="opt-pickup" class="f-btn" onclick="setFulfillment('Pickup')">
                        <i data-lucide="store"></i><br>Come to Shop
                    </div>
                </div>

                <div id="addr-box">
                    <label style="font-weight:600;">Delivery Address</label>
                    <textarea id="c-address" class="form-input" placeholder="District, Sector, Street..." rows="2" required></textarea>
                </div>
                
                <div id="pickup-msg" class="hidden" style="background:#f3f4f6; padding:15px; border-radius:8px; margin-bottom:15px; font-size:0.9rem;">
                    üìç <strong>Shop Location:</strong> KN 2 St, Kigali (Downtown).<br>We will reserve your items for 24 hours.
                </div>

                <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center; background:var(--bg); padding:15px; border-radius:10px;">
                    <span style="font-weight:700;">Total to Pay:</span>
                    <span id="checkout-total" style="font-size:1.2rem; color:var(--primary); font-weight:800;">0</span>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:15px;">
                    Send Order via WhatsApp
                </button>
            </form>
        </div>
    </div>

    <div class="cart-sidebar" id="cart-bar">
        <div style="padding:25px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
            <h3 style="font-size:1.4rem;">Your Cart</h3>
            <button onclick="toggleCart()" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        <div id="cart-items" style="flex:1; overflow-y:auto; padding:20px;"></div>
        <div style="padding:25px; background:var(--bg); border-top:1px solid var(--border);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:700; font-size:1.2rem;">
                <span>Subtotal</span>
                <span id="cart-subtotal">0 RWF</span>
            </div>
            <button class="btn btn-primary" style="width:100%; padding:15px;" onclick="openCheckout()">
                Proceed to Checkout
            </button>
        </div>
    </div>

    <script>
        // --- SECURITY UTILS ---
        function sanitize(str) {
            if(!str) return '';
            const temp = document.createElement('div');
            temp.innerText = str;
            return temp.innerHTML; 
        }

        // --- STATE ---
        // Changed keys to 'newtextile_' to reset data for the new brand
        let products = JSON.parse(localStorage.getItem('newtextile_products')) || [];
        let orders = JSON.parse(localStorage.getItem('newtextile_orders')) || [];
        let cart = [];
        let currentProduct = null;
        let fulfillmentType = 'Delivery';

        // --- INIT ---
        window.onload = () => {
            renderStore();
            lucide.createIcons();
        };

        // --- AUTH ---
        function checkAdminAccess() {
            if(sessionStorage.getItem('isAdmin') === 'true') {
                showAdminPanel();
            } else {
                document.getElementById('login-modal').style.display = 'grid';
            }
        }

        function attemptLogin() {
            const pass = document.getElementById('admin-pass').value;
            // Simple Client-Side Check
            if(pass === 'admin123') { 
                sessionStorage.setItem('isAdmin', 'true');
                document.getElementById('login-modal').style.display = 'none';
                showAdminPanel();
            } else {
                document.getElementById('login-error').innerText = "Incorrect Password";
            }
        }

        function showAdminPanel() {
            document.getElementById('store-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            renderAdminInventory();
            renderAdminOrders();
        }

        function adminLogout() {
            sessionStorage.removeItem('isAdmin');
            location.reload();
        }

        // --- ADMIN: INVENTORY & IMAGE UPLOAD ---
        function handleAddProduct(e) {
            e.preventDefault();
            const fileInput = document.getElementById('p-file');
            const file = fileInput.files[0];

            if(file) {
                if(file.size > 2500000) { alert("Image too large! Use image < 2.5MB"); return; }
                
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const newProd = {
                        id: Date.now(),
                        name: sanitize(document.getElementById('p-name').value),
                        cat: document.getElementById('p-cat').value,
                        price: parseFloat(document.getElementById('p-price').value),
                        desc: sanitize(document.getElementById('p-desc').value),
                        img: evt.target.result // Base64 String
                    };
                    products.push(newProd);
                    localStorage.setItem('newtextile_products', JSON.stringify(products));
                    renderAdminInventory();
                    alert("Product Saved Successfully!");
                    e.target.reset();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderAdminInventory() {
            const container = document.getElementById('admin-list');
            if(products.length === 0) {
                container.innerHTML = '<p style="color:var(--text-muted)">No products yet.</p>';
                return;
            }
            container.innerHTML = products.map(p => `
                <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:15px; border:1px solid #ddd; border-radius:12px;">
                    <div style="display:flex; gap:15px; align-items:center;">
                        <img src="${p.img}" style="width:60px; height:60px; border-radius:8px; object-fit:cover; border:1px solid #eee;">
                        <div>
                            <strong style="font-size:1.1rem;">${p.name}</strong><br>
                            <span class="status-badge" style="background:#eee; color:#666;">${p.cat}</span>
                            <span style="margin-left:10px; font-weight:600; color:var(--primary);">${p.price.toLocaleString()} RWF</span>
                        </div>
                    </div>
                    <button class="btn btn-outline" style="color:#ef4444; border-color:#ef4444;" onclick="deleteProduct(${p.id})">
                        <i data-lucide="trash-2" style="width:18px;"></i>
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function deleteProduct(id) {
            if(confirm("Delete this product permanently?")) {
                products = products.filter(p => p.id !== id);
                localStorage.setItem('newtextile_products', JSON.stringify(products));
                renderAdminInventory();
            }
        }

        // --- ADMIN: ORDER MANAGEMENT ---
        function switchAdminTab(tab, btn) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            document.getElementById('tab-inventory').classList.add('hidden');
            document.getElementById('tab-orders').classList.add('hidden');
            
            if(tab === 'inventory') {
                document.getElementById('tab-inventory').classList.remove('hidden');
            } else {
                document.getElementById('tab-orders').classList.remove('hidden');
                renderAdminOrders();
            }
        }

        function renderAdminOrders() {
            const list = document.getElementById('orders-list');
            if(orders.length === 0) { list.innerHTML = "<p>No active orders.</p>"; return; }

            list.innerHTML = orders.slice().reverse().map(o => `
                <div class="order-card">
                    <div style="flex:1; min-width:300px;">
                        <div class="order-header">
                            <strong><i data-lucide="hash"></i> ${o.id.toString().slice(-6)}</strong>
                            <span class="status-badge ${o.method === 'Delivery' ? 'status-delivery' : 'status-pickup'}">${o.method}</span>
                        </div>
                        <p style="margin-bottom:5px;"><strong>Customer:</strong> ${o.customer}</p>
                        <p style="margin-bottom:5px;"><strong>Phone:</strong> ${o.phone}</p>
                        <p style="margin-bottom:10px;"><strong>Address:</strong> ${o.address || 'Shop Pickup'}</p>
                        <div style="background:#f8fafc; padding:10px; border-radius:8px; font-size:0.9rem;">
                            ${o.items.map(i => `<div>‚Ä¢ ${i.name} (${i.details})</div>`).join('')}
                        </div>
                        <p style="margin-top:15px; font-weight:700; font-size:1.1rem; color:var(--primary);">Total: ${o.total.toLocaleString()} RWF</p>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:10px; justify-content:center; min-width:180px;">
                        <button class="btn btn-success" onclick="respondOnWhatsApp('${o.phone}', '${o.customer}', ${o.id})">
                            <i data-lucide="message-circle"></i> Reply on WhatsApp
                        </button>
                        <button class="btn btn-outline" onclick="deleteOrder(${o.id})">
                            <i data-lucide="archive"></i> Archive
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function respondOnWhatsApp(phone, name, orderId) {
            let p = phone.replace(/\D/g,''); // clean phone
            if(p.startsWith('0')) p = '250' + p.substring(1);
            
            const msg = `Hello ${name}, thank you for ordering from New Textile (Order #${orderId.toString().slice(-6)}). We have received your request.`;
            window.open(`https://wa.me/${p}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function deleteOrder(id) {
            if(confirm("Archive this order?")) {
                orders = orders.filter(o => o.id !== id);
                localStorage.setItem('newtextile_orders', JSON.stringify(orders));
                renderAdminOrders();
            }
        }

        // --- STORE & CART LOGIC ---
        function renderStore() {
            const grid = document.getElementById('product-grid');
            if(products.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:50px;">
                    <i data-lucide="package-open" size="48" color="#ccc"></i>
                    <p style="color:var(--text-muted); margin-top:10px;">No products in store yet.</p>
                </div>`;
                lucide.createIcons();
                return;
            }
            // Display all initially
            grid.innerHTML = products.map(generateCard).join('');
            lucide.createIcons();
        }

        function generateCard(p) {
            return `
                <div class="card" onclick="openProduct(${p.id})">
                    <div class="card-img">
                        <span class="card-tag">${p.cat.toUpperCase()}</span>
                        <img src="${p.img}" alt="${p.name}">
                    </div>
                    <div class="card-info">
                        <h3>${p.name}</h3>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="color:var(--primary); font-weight:700;">${p.price.toLocaleString()} RWF</span>
                            <span style="font-size:0.8rem; color:var(--text-muted)">${p.cat === 'accessory' ? '/unit' : '/meter'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterProducts(cat, btn) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            
            const grid = document.getElementById('product-grid');
            const filtered = cat === 'all' ? products : products.filter(p => p.cat === cat);
            
            if(filtered.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-muted);">No items found in this category.</div>`;
            } else {
                grid.innerHTML = filtered.map(generateCard).join('');
            }
            lucide.createIcons();
        }

        function openProduct(id) {
            currentProduct = products.find(p => p.id === id);
            document.getElementById('m-img').src = currentProduct.img;
            document.getElementById('m-title').innerText = currentProduct.name;
            document.getElementById('m-desc').innerText = currentProduct.desc || "No description available.";
            document.getElementById('m-price').innerText = currentProduct.price.toLocaleString() + " RWF";
            document.getElementById('m-tag').innerText = currentProduct.cat.toUpperCase();

            // Toggle Inputs based on type
            if(currentProduct.cat === 'accessory') {
                document.getElementById('input-qty').classList.remove('hidden');
                document.getElementById('input-measure').classList.add('hidden');
            } else {
                document.getElementById('input-qty').classList.add('hidden');
                document.getElementById('input-measure').classList.remove('hidden');
            }
            
            // Reset values
            document.getElementById('calc-val-m').value = 1;
            document.getElementById('calc-val-q').value = 1;
            
            updateTotal();
            document.getElementById('product-modal').style.display = 'flex';
        }

        function updateTotal() {
            let total = 0;
            if(currentProduct.cat === 'accessory') {
                const q = document.getElementById('calc-val-q').value || 0;
                total = q * currentProduct.price;
            } else {
                const m = document.getElementById('calc-val-m').value || 0;
                total = m * currentProduct.price;
            }
            document.getElementById('calc-total').innerText = total.toLocaleString() + " RWF";
        }

        function addToCart() {
            let details = "";
            let finalPrice = 0;

            if(currentProduct.cat === 'accessory') {
                const q = document.getElementById('calc-val-q').value;
                details = `${q} Units`;
                finalPrice = q * currentProduct.price;
            } else {
                const m = document.getElementById('calc-val-m').value;
                details = `${m} Meters`;
                finalPrice = m * currentProduct.price;
            }

            cart.push({ ...currentProduct, details, finalPrice, cartId: Date.now() });
            updateCartUI();
            closeModals();
        }

        function updateCartUI() {
            document.getElementById('cart-count').innerText = cart.length;
            const container = document.getElementById('cart-items');
            
            if(cart.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:var(--text-muted); margin-top:50px;">Your cart is empty.</p>`;
                document.getElementById('cart-subtotal').innerText = "0 RWF";
                return;
            }

            let subtotal = 0;
            container.innerHTML = cart.map((c, index) => {
                subtotal += c.finalPrice;
                return `
                <div style="display:flex; gap:15px; margin-bottom:20px; align-items:center;">
                    <img src="${c.img}" style="width:60px; height:60px; border-radius:8px; object-fit:cover;">
                    <div style="flex:1;">
                        <h4 style="font-size:0.95rem; margin-bottom:4px;">${c.name}</h4>
                        <div style="font-size:0.85rem; color:var(--text-muted);">${c.details}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:600;">${c.finalPrice.toLocaleString()}</div>
                        <button onclick="removeFromCart(${index})" style="color:red; font-size:0.75rem; background:none; border:none; cursor:pointer; text-decoration:underline;">Remove</button>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('cart-subtotal').innerText = subtotal.toLocaleString() + " RWF";
            document.getElementById('checkout-total').innerText = subtotal.toLocaleString() + " RWF";
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartUI();
        }

        function toggleCart() { document.getElementById('cart-bar').classList.toggle('open'); }
        
        function openCheckout() { 
            if(cart.length === 0) return alert("Please add items to cart first.");
            toggleCart();
            document.getElementById('checkout-modal').style.display = 'grid'; 
        }

        function setFulfillment(type) {
            fulfillmentType = type;
            document.getElementById('opt-delivery').classList.remove('active');
            document.getElementById('opt-pickup').classList.remove('active');
            
            if(type === 'Delivery') {
                document.getElementById('opt-delivery').classList.add('active');
                document.getElementById('addr-box').classList.remove('hidden');
                document.getElementById('pickup-msg').classList.add('hidden');
                document.getElementById('c-address').required = true;
            } else {
                document.getElementById('opt-pickup').classList.add('active');
                document.getElementById('addr-box').classList.add('hidden');
                document.getElementById('pickup-msg').classList.remove('hidden');
                document.getElementById('c-address').required = false;
            }
        }

        function submitOrder(e) {
            e.preventDefault();
            const orderTotal = cart.reduce((acc, c) => acc + c.finalPrice, 0);
            
            const order = {
                id: Date.now(),
                customer: sanitize(document.getElementById('c-name').value),
                phone: sanitize(document.getElementById('c-phone').value),
                method: fulfillmentType,
                address: fulfillmentType === 'Delivery' ? sanitize(document.getElementById('c-address').value) : null,
                items: [...cart],
                total: orderTotal,
                status: 'pending'
            };

            orders.push(order);
            localStorage.setItem('newtextile_orders', JSON.stringify(orders));
            
            // Construct WhatsApp Message
            let msg = `*NEW ORDER: New Textile*\n`;
            msg += `Customer: ${order.customer}\n`;
            msg += `Phone: ${order.phone}\n`;
            msg += `Method: ${order.method}\n`;
            if(order.address) msg += `Address: ${order.address}\n`;
            msg += `----------------\n`;
            order.items.forEach(i => {
                msg += `- ${i.name} (${i.details}): ${i.finalPrice.toLocaleString()}\n`;
            });
            msg += `----------------\n`;
            msg += `*TOTAL: ${order.total.toLocaleString()} RWF*`;

            // Clear Cart and Redirect
            cart = [];
            updateCartUI();
            closeModals();
            
            // Send to Admin WhatsApp (Replace with Company Number)
            const companyPhone = "250795817707"; 
            window.open(`https://wa.me/${companyPhone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }
    </script>
</body>
</html>