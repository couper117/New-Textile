<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Textile | Quality Curtains Rwanda</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #c2410c;
            --primary-hover: #9a3412;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #0f172a;
            --text-muted: #64748b;
            --success: #16a34a;
            --warning: #ca8a04;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        * { margin: 0; 
            padding: 0;
             box-sizing: border-box;
              font-family: 'Plus Jakarta Sans', sans-serif; }
              
        body { background: var(--bg); 
            color: var(--text);
             min-height: 100vh;
              display: flex;
               flex-direction: column;
                font-size: 14px; }

        .hidden { display: none !important; }

        .btn { padding: 12px 24px; 
            border-radius: 8px;
             border: none;
              font-weight: 600; 
             cursor: pointer; 
             display: flex; 
             align-items: center;
              justify-content: center; 
              gap: 8px;
               transition: 0.2s; }

        .btn-primary { background: var(--primary);
             color: white; }

        .btn-primary:hover { background: var(--primary-hover); }

        .btn-outline { background: transparent;
             border: 1px solid var(--border);
              color: var(--text); }

        .btn-success { background: var(--success);
             color: white; }
        
        nav { height: 70px;
             display: flex;
              align-items: center;
              justify-content: space-between;
               padding: 0 5%;
                background: var(--surface);
                 position: sticky;
                  top: 0; 
                  z-index: 1000;
                   border-bottom: 1px solid var(--border); }

        .logo { font-weight: 800; 
            font-size: 1.4rem;
             color: var(--primary);
              display: flex;
               align-items: center;
                gap: 8px;
                 text-transform: uppercase;
                  letter-spacing: -0.5px; }

        .nav-tools { display: flex; 
            gap: 15px;
             align-items: center; }

        .icon-btn { position: relative; 
            width: 40px;
             height: 40px;
              border-radius: 50%;
               background: var(--bg);
                display: flex;
                 align-items: center;
                  justify-content: center;
                   cursor: pointer;
                    border: 1px solid var(--border);
                     transition: 0.2s; }

        .icon-btn:hover { background: var(--border); }

        .badge { position: absolute; 
            top: -2px;
             right: -2px; 
             background: var(--primary);
              color: white;
               font-size: 0.7rem;
                padding: 2px 6px; 
                border-radius: 10px; }

        .container { max-width: 1400px;
             margin: 0 auto;
              padding: 30px 5%; 
              width: 100%;
               flex: 1; }
        
        .hero { text-align: center;
             margin-bottom: 40px;
              padding: 40px 20px;
               background: var(--surface); 
               border-radius: 20px; 
               border: 1px solid var(--border); }

        .hero h1 { font-size: 2.2rem; 
            margin-bottom: 10px;
             color: var(--text); }
        
        .tabs { display: flex; 
            gap: 10px;
             margin-bottom: 25px;
              overflow-x: auto;
               padding-bottom: 5px;
                justify-content: center; }

        .tab { padding: 10px 24px;
             border-radius: 30px;
              background: var(--surface); 
              border: 1px solid var(--border);
               cursor: pointer;
                white-space: nowrap; 
                font-weight: 600;
                 transition: 0.2s; }

        .tab:hover { border-color: var(--primary); }

        .tab.active { background: var(--primary); 
            color: white;
             border-color: var(--primary); }
        
        .grid { display: grid;
             grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
              gap: 25px; }

        .card { background: var(--surface); 
            border-radius: 16px;
             border: 1px solid var(--border);
              overflow: hidden; 
              cursor: pointer;
               transition: 0.3s;
                position: relative; }

        .card:hover { transform: translateY(-5px);
             box-shadow: var(--shadow);
              border-color: var(--primary); }
        
        .card-img { height: 220px;
             background: #f1f5f9; 
             position: relative;
              overflow: hidden;
               display: flex; 
               align-items: center;
                justify-content: center; }

        .card-img img { width: 100%;
             height: 100%; 
             object-fit: cover; }

        .card-tag { position: absolute;
             top: 10px;
              left: 10px;
               background: rgba(0,0,0,0.7);
                color: white;
                 padding: 4px 10px;
                  border-radius: 20px;
                   font-size: 0.75rem;
                    font-weight: 600; }

        .card-info { padding: 15px; }

        .card h3 { font-size: 1.1rem;
             margin-bottom: 5px; }

        #admin-view { background: var(--surface);
             border-radius: 20px; 
             border: 1px solid var(--border);
              padding: 30px;
               box-shadow: var(--shadow); }

        .admin-nav { display: flex; 
            gap: 20px;
             border-bottom: 1px solid var(--border);
              margin-bottom: 20px; }

        .admin-tab { padding: 10px 0; 
            cursor: pointer; 
            color: var(--text-muted); 
            font-weight: 600;
             border-bottom: 2px solid transparent; }

        .admin-tab:hover { color: var(--primary); }

        .admin-tab.active { color: var(--primary); border-color: var(--primary); }


        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }
        .form-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); outline: none; background: var(--bg); transition: 0.2s; }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(194, 65, 12, 0.1); }
        
        .order-card { border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 15px; background: var(--bg); display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; }
        .status-delivery { background: #dbeafe; color: #1e40af; }
        .status-pickup { background: #f3e8ff; color: #6b21a8; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; place-items: center; z-index: 5000; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--surface); width: 100%; max-width: 900px; border-radius: 24px; overflow: hidden; display: flex; max-height: 90vh; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        @media (max-width: 768px) { .modal-content { flex-direction: column; overflow-y: auto; } }
        
        .login-box { background: var(--surface); padding: 40px; border-radius: 24px; width: 100%; max-width: 400px; text-align: center; }

        .cart-sidebar { position: fixed; top: 0; right: -450px; width: 450px; height: 100vh; background: var(--surface); z-index: 4000; border-left: 1px solid var(--border); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.1); }
        @media(max-width: 500px) { .cart-sidebar { width: 100%; } }
        .cart-sidebar.open { right: 0; }

        .fulfillment-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .f-btn { padding: 15px; border: 1px solid var(--border); border-radius: 12px; text-align: center; cursor: pointer; background: var(--bg); font-weight: 600; transition: 0.2s; }
        .f-btn:hover { border-color: var(--primary); }
        .f-btn.active { border-color: var(--primary); background: #fff7ed; color: var(--primary); }

        .live-indicator { display: inline-flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--success); font-weight: 600; }
        .live-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .product-item { border: 1px solid var(--border); border-radius: 12px; padding: 15px; margin-bottom: 15px; background: white; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .product-item img { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; }
        .product-item-info { flex: 1; }
        .product-item-actions { display: flex; gap: 10px; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">
            <i data-lucide="layers"></i> New Textile
        </div>
        <div class="nav-tools">
            <button class="icon-btn" onclick="checkAdminAccess()" title="Admin Login">
                <i data-lucide="lock"></i>
            </button>
            <button class="icon-btn" onclick="toggleCart()">
                <i data-lucide="shopping-cart"></i>
                <span class="badge" id="cart-count">0</span>
            </button>
        </div>
    </nav>

    <main class="container">
        <div id="store-view">
            <div class="hero">
                <h1>New Textile Company Ltd</h1>
                <p style="color: var(--text-muted); max-width: 600px; margin: 0 auto;">
                    We provide the highest quality curtains and home accessories in Rwanda. 
                    <span class="live-indicator" id="live-status">
                        <span class="live-dot"></span> Live Updates
                    </span>
                </p>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="filterProducts('all', this)">All Collections</div>
                <div class="tab" onclick="filterProducts('night', this)">Night Curtains</div>
                <div class="tab" onclick="filterProducts('day', this)">Day Curtains</div>
                <div class="tab" onclick="filterProducts('accessory', this)">Accessories</div>
            </div>
            
            <div class="grid" id="product-grid"></div>
        </div>

        <div id="admin-view" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div>
                    <h2 style="font-size: 1.5rem;">Admin Dashboard</h2>
                    <p style="color: var(--text-muted);">Manage New Textile Inventory
                        <span class="live-indicator">
                            <span class="live-dot"></span> Real-Time Sync
                        </span>
                    </p>
                </div>
                <button class="btn btn-outline" onclick="adminLogout()">
                    <i data-lucide="log-out"></i> Logout
                </button>
            </div>
            
            <div class="admin-nav">
                <div class="admin-tab active" onclick="switchAdminTab('inventory', this)">Inventory</div>
                <div class="admin-tab" onclick="switchAdminTab('orders', this)">Orders</div>
            </div>

            <div id="tab-inventory">
                <div style="background: var(--bg); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--border);">
                    <h3 style="margin-bottom: 15px; display:flex; align-items:center; gap:8px;"><i data-lucide="plus-circle"></i> Add New Product</h3>
                    <form onsubmit="handleAddProduct(event)">
                        <div class="form-grid">
                            <div>
                                <label style="display:block; margin-bottom:5px; font-weight:600;">Product Name</label>
                                <input type="text" id="p-name" class="form-input" placeholder="e.g. Velvet Gold" required>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:5px; font-weight:600;">Category</label>
                                <select id="p-cat" class="form-input">
                                    <option value="night">Night Curtain (Z'ijoro)</option>
                                    <option value="day">Day Curtain (Z'amanywa)</option>
                                    <option value="accessory">Accessory (Ibikoresho)</option>
                                </select>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:5px; font-weight:600;">Price (RWF)</label>
                                <input type="number" id="p-price" class="form-input" placeholder="e.g. 15000" required>
                            </div>
                            <div>
                                <label style="display:block; margin-bottom:5px; font-weight:600;">Upload Image</label>
                                <input type="file" id="p-file" class="form-input" accept="image/*" required>
                                <small style="color:var(--text-muted)">Max size 2MB (JPG/PNG)</small>
                            </div>
                        </div>
                        <textarea id="p-desc" class="form-input" rows="2" placeholder="Product Description..." style="margin-bottom:15px;"></textarea>
                        <button type="submit" class="btn btn-primary" style="width:100%">Save Product</button>
                    </form>
                </div>
                <h3>Current Stock</h3>
                <div id="admin-list" style="display:grid; gap:10px; margin-top:15px;"></div>
            </div>

            <div id="tab-orders" class="hidden">
                <h3>Incoming Orders</h3>
                <div id="orders-list" style="margin-top:15px;"></div>
            </div>
        </div>
    </main>

    <div id="login-modal" class="modal">
        <div class="login-box">
            <i data-lucide="shield-check" style="width:50px; height:50px; color:var(--primary); margin-bottom:15px;"></i>
            <h2 style="margin-bottom:10px;">Admin Login</h2>
            <p style="color:var(--text-muted); margin-bottom:20px;">Enter Admin password</p>
            <input type="password" id="admin-pass" class="form-input" placeholder="Password" style="margin-bottom:15px; text-align:center;">
            <button class="btn btn-primary" style="width:100%" onclick="attemptLogin()">Login</button>
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="closeModals()">Cancel</button>
            <p style="margin-top:15px; font-size:0.8rem; color:red;" id="login-error"></p>
        </div>
    </div>

    <div id="product-modal" class="modal" onclick="closeModals()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div style="flex:1; background:#f0f0f0; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                <img id="m-img" src="" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <div style="flex:1; padding:40px; display:flex; flex-direction:column; overflow-y:auto;">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <span id="m-tag" class="status-badge" style="background:var(--text); color:white;">TAG</span>
                    <button onclick="closeModals()" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
                </div>
                
                <h2 id="m-title" style="font-size:2rem; margin:15px 0 5px;">Title</h2>
                <p id="m-price" style="color:var(--primary); font-weight:700; font-size:1.5rem; margin-bottom:20px;">0 RWF</p>
                <p id="m-desc" style="color:var(--text-muted); line-height:1.6; margin-bottom:30px;"></p>
                
                <div style="background:var(--bg); padding:20px; border-radius:12px; border:1px solid var(--border); margin-bottom:20px;">
                    <div id="input-measure" class="hidden">
                        <label style="font-weight:600; display:block; margin-bottom:8px;">How many meters width?</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" id="calc-val-m" value="1" min="1" step="0.5" class="form-input" oninput="updateTotal()">
                            <span>Meters</span>
                        </div>
                    </div>
                    <div id="input-qty" class="hidden">
                        <label style="font-weight:600; display:block; margin-bottom:8px;">Quantity needed:</label>
                        <input type="number" id="calc-val-q" value="1" min="1" class="form-input" oninput="updateTotal()">
                    </div>
                    <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:600;">Total Amount:</span>
                        <span id="calc-total" style="font-size:1.4rem; font-weight:800; color:var(--primary);">0 RWF</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addToCart()" style="padding:15px;">
                    Add to Cart <i data-lucide="arrow-right" style="width:18px;"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="modal">
        <div class="login-box" style="text-align:left; max-width:550px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Confirm Order</h2>
                <button onclick="closeModals()" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
            </div>
            
            <form onsubmit="submitOrder(event)">
                <div class="form-grid" style="gap:15px;">
                    <div>
                        <label>Full Name</label>
                        <input type="text" id="c-name" class="form-input" required>
                    </div>
                    <div>
                        <label>Phone (WhatsApp)</label>
                        <input type="tel" id="c-phone" class="form-input" placeholder="07..." required>
                    </div>
                </div>
                
                <label style="font-weight:600; margin-top:10px; display:block;">Delivery Method</label>
                <div class="fulfillment-options">
                    <div id="opt-delivery" class="f-btn active" onclick="setFulfillment('Delivery')">
                        <i data-lucide="bike"></i><br>Moto Delivery
                    </div>
                    <div id="opt-pickup" class="f-btn" onclick="setFulfillment('Pickup')">
                        <i data-lucide="store"></i><br>Come to Shop
                    </div>
                </div>

                <div id="addr-box">
                    <label style="font-weight:600;">Delivery Address</label>
                    <textarea id="c-address" class="form-input" placeholder="District, Sector, Street..." rows="2" required></textarea>
                </div>
                
                <div id="pickup-msg" class="hidden" style="background:#f3f4f6; padding:15px; border-radius:8px; margin-bottom:15px; font-size:0.9rem;">
                    üìç <strong>Shop Location:</strong> KN 2 St, Kigali (Downtown).<br>We will reserve your items for 24 hours.
                </div>

                <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center; background:var(--bg); padding:15px; border-radius:10px;">
                    <span style="font-weight:700;">Total to Pay:</span>
                    <span id="checkout-total" style="font-size:1.2rem; color:var(--primary); font-weight:800;">0</span>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width:100%; margin-top:15px;">
                    Send Order via WhatsApp
                </button>
            </form>
        </div>
    </div>

    <div class="cart-sidebar" id="cart-bar">
        <div style="padding:25px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
            <h3 style="font-size:1.4rem;">Your Cart</h3>
            <button onclick="toggleCart()" style="background:none; border:none; cursor:pointer;"><i data-lucide="x"></i></button>
        </div>
        <div id="cart-items" style="flex:1; overflow-y:auto; padding:20px;"></div>
        <div style="padding:25px; background:var(--bg); border-top:1px solid var(--border);">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-weight:700; font-size:1.2rem;">
                <span>Subtotal</span>
                <span id="cart-subtotal">0 RWF</span>
            </div>
            <button class="btn btn-primary" style="width:100%; padding:15px;" onclick="openCheckout()">
                Proceed to Checkout
            </button>
        </div>
    </div>

   <script type="module">
    // ==================== FIREBASE SETUP ====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // üî¥ PASTE YOUR FIREBASE CONFIG HERE üî¥
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ==================== STATE MANAGEMENT ====================
    let products = [];
    let orders = [];
    let cart = [];
    let currentProduct = null;
    let fulfillmentType = 'Delivery';

    // ==================== GLOBAL FUNCTIONS (Window Binding) ====================
    // Because we are using modules, we must attach functions to 'window' to make HTML onclick work
    
    window.onload = () => {
        listenToProducts(); // Real-time listener
        listenToOrders();   // Real-time listener
        lucide.createIcons();
    };

    // --- REAL-TIME LISTENERS ---
    function listenToProducts() {
        const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderStore();
            if(!document.getElementById('admin-view').classList.contains('hidden')) {
                renderAdminInventory();
            }
        });
    }

    function listenToOrders() {
        const q = query(collection(db, "orders"), orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if(!document.getElementById('admin-view').classList.contains('hidden')) {
                renderAdminOrders();
            }
        });
    }

    // --- ADMIN AUTH ---
    window.checkAdminAccess = function() {
        if(sessionStorage.getItem('isAdmin') === 'true') {
            window.showAdminPanel();
        } else {
            document.getElementById('login-modal').style.display = 'grid';
        }
    }

    window.attemptLogin = function() {
        const pass = document.getElementById('admin-pass').value;
        if(pass === 'admin123') { // Simple check
            sessionStorage.setItem('isAdmin', 'true');
            document.getElementById('login-modal').style.display = 'none';
            window.showAdminPanel();
            document.getElementById('admin-pass').value = '';
        } else {
            document.getElementById('login-error').innerText = "‚ùå Incorrect Password";
        }
    }

    window.showAdminPanel = function() {
        document.getElementById('store-view').classList.add('hidden');
        document.getElementById('admin-view').classList.remove('hidden');
        renderAdminInventory();
        renderAdminOrders();
    }

    window.adminLogout = function() {
        sessionStorage.removeItem('isAdmin');
        document.getElementById('admin-view').classList.add('hidden');
        document.getElementById('store-view').classList.remove('hidden');
        renderStore();
    }

    window.switchAdminTab = function(tab, btn) {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('tab-inventory').classList.add('hidden');
        document.getElementById('tab-orders').classList.add('hidden');
        if(tab === 'inventory') document.getElementById('tab-inventory').classList.remove('hidden');
        else document.getElementById('tab-orders').classList.remove('hidden');
    }

    // --- PRODUCT MANAGEMENT (DATABASE) ---
    window.handleAddProduct = async function(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = "Uploading...";
        btn.disabled = true;

        const file = document.getElementById('p-file').files[0];
        
        try {
            // 1. Upload Image to Firebase Storage
            const storageRef = ref(storage, 'products/' + Date.now() + '-' + file.name);
            await uploadBytes(storageRef, file);
            const imageUrl = await getDownloadURL(storageRef);

            // 2. Save Data to Firestore
            await addDoc(collection(db, "products"), {
                name: document.getElementById('p-name').value,
                cat: document.getElementById('p-cat').value,
                price: parseFloat(document.getElementById('p-price').value),
                desc: document.getElementById('p-desc').value,
                img: imageUrl,
                createdAt: Date.now()
            });

            alert("‚úÖ Product Saved to Database!");
            e.target.reset();
        } catch (error) {
            console.error(error);
            alert("Error saving product: " + error.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    window.deleteProduct = async function(id) {
        if(confirm("Delete this product permanently?")) {
            await deleteDoc(doc(db, "products", id));
        }
    }

    // --- STORE RENDERING ---
    function renderStore() {
        const grid = document.getElementById('product-grid');
        if(products.length === 0) {
            grid.innerHTML = '<p style="padding:40px; text-align:center;">Loading products...</p>';
            return;
        }
        // Check for active filter
        const activeTab = document.querySelector('.tab.active');
        const filter = activeTab ? activeTab.innerText.toLowerCase() : 'all';
        
        // Re-run filter logic to show correct items
        if(filter.includes('night')) window.filterProducts('night', activeTab);
        else if(filter.includes('day')) window.filterProducts('day', activeTab);
        else if(filter.includes('access')) window.filterProducts('accessory', activeTab);
        else window.filterProducts('all', document.querySelector('.tab:first-child'));
    }

    window.filterProducts = function(cat, btn) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        const grid = document.getElementById('product-grid');
        const filtered = cat === 'all' ? products : products.filter(p => p.cat === cat);
        
        grid.innerHTML = filtered.map(p => `
            <div class="card" onclick="openProduct('${p.id}')">
                <div class="card-img">
                    <span class="card-tag">${p.cat.toUpperCase()}</span>
                    <img src="${p.img}" alt="${p.name}">
                </div>
                <div class="card-info">
                    <h3>${p.name}</h3>
                    <div style="display:flex; justify-content:space-between;">
                        <span style="color:var(--primary); font-weight:700;">${p.price.toLocaleString()} RWF</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderAdminInventory() {
        const container = document.getElementById('admin-list');
        container.innerHTML = products.map(p => `
            <div class="product-item">
                <img src="${p.img}">
                <div class="product-item-info">
                    <strong>${p.name}</strong><br>
                    <span>${p.price.toLocaleString()} RWF</span>
                </div>
                <button class="btn btn-outline" style="color:red; border-color:red" onclick="deleteProduct('${p.id}')">
                    <i data-lucide="trash-2"></i>
                </button>
            </div>
        `).join('');
        lucide.createIcons();
    }

    // --- CART & MODALS ---
    window.openProduct = function(id) {
        currentProduct = products.find(p => p.id === id);
        document.getElementById('m-img').src = currentProduct.img;
        document.getElementById('m-title').innerText = currentProduct.name;
        document.getElementById('m-desc').innerText = currentProduct.desc;
        document.getElementById('m-price').innerText = currentProduct.price.toLocaleString() + " RWF";
        document.getElementById('m-tag').innerText = currentProduct.cat.toUpperCase();
        
        // Toggle inputs based on category
        if(currentProduct.cat === 'accessory') {
            document.getElementById('input-qty').classList.remove('hidden');
            document.getElementById('input-measure').classList.add('hidden');
        } else {
            document.getElementById('input-qty').classList.add('hidden');
            document.getElementById('input-measure').classList.remove('hidden');
        }
        document.getElementById('product-modal').style.display = 'flex';
        window.updateTotal();
    }

    window.updateTotal = function() {
        let total = 0;
        if(currentProduct.cat === 'accessory') {
            total = (document.getElementById('calc-val-q').value || 1) * currentProduct.price;
        } else {
            total = (document.getElementById('calc-val-m').value || 1) * currentProduct.price;
        }
        document.getElementById('calc-total').innerText = total.toLocaleString() + " RWF";
    }

    window.addToCart = function() {
        let details = "", finalPrice = 0;
        if(currentProduct.cat === 'accessory') {
            const q = document.getElementById('calc-val-q').value;
            details = `${q} Units`;
            finalPrice = q * currentProduct.price;
        } else {
            const m = document.getElementById('calc-val-m').value;
            details = `${m} Meters`;
            finalPrice = m * currentProduct.price;
        }
        cart.push({ ...currentProduct, details, finalPrice, cartId: Date.now() });
        updateCartUI();
        window.closeModals();
    }

    function updateCartUI() {
        document.getElementById('cart-count').innerText = cart.length;
        const container = document.getElementById('cart-items');
        let subtotal = 0;
        
        container.innerHTML = cart.map((c, idx) => {
            subtotal += c.finalPrice;
            return `
                <div style="display:flex; gap:15px; margin-bottom:15px;">
                    <img src="${c.img}" style="width:50px; height:50px; border-radius:5px; object-fit:cover;">
                    <div style="flex:1">
                        <b>${c.name}</b><br>
                        <small>${c.details}</small>
                    </div>
                    <div style="text-align:right">
                        <b>${c.finalPrice.toLocaleString()}</b><br>
                        <a href="#" onclick="removeFromCart(${idx})" style="color:red; font-size:0.8rem">Remove</a>
                    </div>
                </div>
            `;
        }).join('');
        
        document.getElementById('cart-subtotal').innerText = subtotal.toLocaleString() + " RWF";
        document.getElementById('checkout-total').innerText = subtotal.toLocaleString();
    }

    window.removeFromCart = function(idx) {
        cart.splice(idx, 1);
        updateCartUI();
    }

    window.toggleCart = function() {
        document.getElementById('cart-bar').classList.toggle('open');
    }

    window.closeModals = function() {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
    }

    // --- CHECKOUT & ORDERS ---
    window.openCheckout = function() {
        if(cart.length === 0) return alert("Cart is empty");
        window.toggleCart();
        document.getElementById('checkout-modal').style.display = 'grid';
    }

    window.setFulfillment = function(type) {
        fulfillmentType = type;
        document.querySelectorAll('.f-btn').forEach(b => b.classList.remove('active'));
        if(type === 'Delivery') {
            document.getElementById('opt-delivery').classList.add('active');
            document.getElementById('addr-box').classList.remove('hidden');
            document.getElementById('pickup-msg').classList.add('hidden');
        } else {
            document.getElementById('opt-pickup').classList.add('active');
            document.getElementById('addr-box').classList.add('hidden');
            document.getElementById('pickup-msg').classList.remove('hidden');
        }
    }

    window.submitOrder = async function(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerText = "Processing...";

        const total = cart.reduce((acc, c) => acc + c.finalPrice, 0);
        const order = {
            customer: document.getElementById('c-name').value,
            phone: document.getElementById('c-phone').value,
            method: fulfillmentType,
            address: fulfillmentType === 'Delivery' ? document.getElementById('c-address').value : 'Shop Pickup',
            items: cart.map(c => ({ name: c.name, details: c.details, price: c.finalPrice })),
            total: total,
            date: Date.now()
        };

        try {
            // Save to Firestore
            const docRef = await addDoc(collection(db, "orders"), order);
            
            // WhatsApp Message
            let msg = `*NEW ORDER #${docRef.id.slice(0,5)}*\nName: ${order.customer}\nPhone: ${order.phone}\nMethod: ${order.method}\n`;
            if(order.address) msg += `Address: ${order.address}\n`;
            msg += `----------------\n`;
            order.items.forEach(i => msg += `- ${i.name} (${i.details})\n`);
            msg += `----------------\n*TOTAL: ${order.total.toLocaleString()} RWF*`;
            
            window.open(`https://wa.me/250795817707?text=${encodeURIComponent(msg)}`, '_blank');
            
            cart = [];
            updateCartUI();
            window.closeModals();
        } catch (err) {
            alert("Error placing order");
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = "Send Order via WhatsApp";
        }
    }

    function renderAdminOrders() {
        const container = document.getElementById('orders-list');
        if(orders.length === 0) {
            container.innerHTML = "<p>No orders found.</p>";
            return;
        }
        container.innerHTML = orders.map(o => `
            <div class="order-card">
                <div style="flex:1">
                    <strong>${o.customer}</strong> <span class="status-badge">${o.method}</span><br>
                    <small>${o.phone}</small><br>
                    <small>${o.address || ''}</small>
                    <div style="background:#f8fafc; padding:8px; margin-top:5px; font-size:0.9rem">
                        ${o.items.map(i => `<div>${i.name} (${i.details})</div>`).join('')}
                    </div>
                    <div style="margin-top:5px; font-weight:bold; color:var(--primary)">${o.total.toLocaleString()} RWF</div>
                </div>
                <button class="btn btn-outline" style="height:fit-content" onclick="deleteOrder('${o.id}')">Archive</button>
            </div>
        `).join('');
    }

    window.deleteOrder = async function(id) {
        if(confirm("Archive this order?")) {
            await deleteDoc(doc(db, "orders", id));
        }
    }
</script>


</body>
</html>